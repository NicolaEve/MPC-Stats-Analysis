---
title: "MPC"
author: "NCompton"
date: "28/06/2021"
output: html_document
---

knit at end

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

install packages and set libraries
```{r, echo = FALSE}
#install.packages("odbc")
#install.packages("DBI")
#install.packages("dplyr")
#install.packages("fitdistrplus")
#install.packages("ggplot2")
#install.packages("qicharts2")
#install.packages("psych")
#install.packages("distributions3")
library(psych)
library(qicharts2)
library(ggplot2)
library(fitdistrplus)
library(dplyr)
library(odbc)
library(distributions3)
```

Define functions
```{r}
# function to check the distribution of the data input
check_distribution <- function(data){
  descdist(data, discrete = FALSE)
  normal_dist <- fitdist(data, "norm")
  plot(normal_dist)
}

# function to return 2-sample z statistic and p value
z.test <- function(x, y){
  # get the sample mean, sd and n
  mu_1 = mean(x)
  mu_2 = mean(y)
  sigma_1 = sd(x)^2
  sigma_2 = sd(y)^2
  n_1 = length(x)
  n_2 = length(y)
  
  # calculate 2 tailed z stat
  z_stat = (mu_1 - mu_2) / (sqrt ((sigma_1/n_1) + (sigma_2/n_2)))
  
  # calculate p value
  Z <- Normal(0,1) # make a standard normal r.v
  p = 2 * cdf(Z, abs(z_stat))
  return(c(z_stat, p))
}
```


Set up the database connection
```{r}
#sort(unique(odbcListDrivers()[[1]]))
con <- DBI::dbConnect(odbc::odbc(), 
                      Driver = "SQL Server", 
                      Server = "IT049561\\SQLEXPRESS", 
                      Database = "MPC", 
                      Trusted_Connection = "True")
```

Get the MPC view as a dataframe
```{sql connection=con, output.var = "mpc_view"}
SELECT *
FROM MPC_View

```

Get a dataframe for each beam energy
```{sql connection=con, output.var = "mpc_6x"}
SELECT *
FROM MPC_View
WHERE Beam_Energy = '6x'
```
```{sql connection=con, output.var = "mpc_10x"}
SELECT *
FROM MPC_View
WHERE Beam_Energy = '10x'

```
```{sql connection=con, output.var = "mpc_10fff"}
SELECT *
FROM MPC_View
WHERE Beam_Energy = '10fff'

```


Descriptive statistics with psych
```{r, echo = FALSE}
centre_shift_mpc <- describeBy(mpc_view$MPC_Distance, mpc_view$Beam_Energy)
centre_shift_mpc

centre_shift_calibrated <- describeBy(mpc_view$Calibrated_Distance, mpc_view$Beam_Energy)
centre_shift_calibrated

uniformity_mpc <- describeBy(mpc_view$Uniformity, mpc_view$Beam_Energy)
uniformity_mpc

output_change_mpc <- describeBy(mpc_view$OutputChange, mpc_view$Beam_Energy)
output_change_mpc
```


Z-test and t-test to compare the beam center shift reported by the MPC and the one calculated in my algorithm

check distributions are normal
```{r}
check_distribution(mpc_6x$MPC_Distance)
check_distribution(mpc_6x$Calibrated_Distance)
check_distribution(mpc_10x$MPC_Distance)
check_distribution(mpc_10x$Calibrated_Distance)
check_distribution(mpc_10fff$MPC_Distance)
check_distribution(mpc_10fff$Calibrated_Distance)
```

Boxplots comparing centre shift reported by MPC and calculated by my algorithm
```{r}
# visualise difference in distributions in a boxplot
boxplot(mpc_6x$MPC_Distance, mpc_6x$Calibrated_Distance)
boxplot(mpc_10x$MPC_Distance, mpc_10x$Calibrated_Distance)
boxplot(mpc_10fff$MPC_Distance, mpc_10fff$Calibrated_Distance)
```

center shift z and t tests
(T-test is not meant to used on samples bigger than 30 but z and t are giving basicallly the same result; just with different p values)
```{r}
z.test(mpc_6x$MPC_Distance, mpc_6x$Calibrated_Distance)
z.test(mpc_10x$MPC_Distance, mpc_10x$Calibrated_Distance)
z.test(mpc_10fff$MPC_Distance, mpc_10fff$Calibrated_Distance)

t.test(mpc_6x$MPC_Distance, mpc_6x$Calibrated_Distance)
t.test(mpc_10x$MPC_Distance, mpc_10x$Calibrated_Distance)
t.test(mpc_10fff$MPC_Distance, mpc_10fff$Calibrated_Distance)
```

Compare the symmetry and flatness before and af


Regression on the beam output change against time
should it be linear?

```{r}
lm <- lm(OutputChange ~ QA_Date, data = mpc_6x)
summary(lm)
```

plot the beam output change over time
```{r}
ggplot(mpc_6x, aes(QA_Date, OutputChange)) +
  geom_point() +
  xlab("QA Date") +
  ylab("Output Change") +
  ggtitle("Output Changes against Time")

```
```{sql connection=con, output.var = "symm6x"}
SELECT "Symmetry", "Flatness", "Beam_Energy", "Inline", "Transformed"
FROM "Linked MPC Data"
WHERE "Beam_Energy" = '6x'AND "Inline" = 1

```
compare the symmetry values once the calibration has been applied to before, for 6x inline
```{r}
check_distribution(symm6x$Flatness)
check_distribution(symm6x$Symmetry)
t.test(Symmetry ~ Transformed, data = symm6x)
t.test(Flatness ~ Transformed, data = symm6x)
z.test(symm6x$Symmetry$Transformed$TRUE, symm6x$Symmetry$Transformed$FALSE)
```
Repeat for crossline
```{sql connection=con, output.var = "symm6xcross"}
SELECT "Symmetry", "Beam_Energy", "Inline", "Transformed"
FROM "Linked MPC Data"
WHERE "Beam_Energy" = '6x'AND "Inline" = 0

```
compare the symmetry values once the calibration has been applied to before, for 6x crossline
```{r}
t.test(Symmetry ~ Transformed, data = symm6xcross)

```
10x inline symmetry
```{sql connection=con, output.var = "symm10xin"}
SELECT "Symmetry", "Beam_Energy", "Inline", "Transformed"
FROM "Linked MPC Data"
WHERE "Beam_Energy" = '10x'AND "Inline" = 1

```

```{r}
t.test(Symmetry ~ Transformed, data = symm10xin)

```
Repeat for crossline
```{sql connection=con, output.var = "symm10xcross"}
SELECT "Symmetry", "Beam_Energy", "Inline", "Transformed"
FROM "Linked MPC Data"
WHERE "Beam_Energy" = '10x'AND "Inline" = 0

```

```{r}
t.test(Symmetry ~ Transformed, data = symm10xcross)

```

10FFF

```{sql connection=con, output.var = "symm10fffin"}
SELECT "Symmetry", "Beam_Energy", "Inline", "Transformed"
FROM "Linked MPC Data"
WHERE "Beam_Energy" = '10fff'AND "Inline" = 1

```

```{r}
t.test(Symmetry ~ Transformed, data = symm10fffin)

```

Repeat for crossline
```{sql connection=con, output.var = "symm10fffcross"}
SELECT "Symmetry", "Beam_Energy", "Inline", "Transformed"
FROM "Linked MPC Data"
WHERE "Beam_Energy" = '10fff'AND "Inline" = 0

```

```{r}
t.test(Symmetry ~ Transformed, data = symm10fffcross)

```

```{r}

qic(mpc_10x$MPC_Distance, chart = 'i')
qic(mpc_10x$Calibrated_Distance, chart = 'i')
qic(mpc_10x$MPC_Distance, chart = 'mr')
qic(mpc_10x$Calibrated_Distance, chart = 'mr')

qic(mpc_6x$OutputChange, x = mpc_6x$QA_Date, chart = 'xbar')
```

