---
title: "MPC"
author: "NCompton"
date: "28/06/2021"
output: html_document
---

knit at end

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

install packages and set libraries
```{r, echo = FALSE}
#install.packages("odbc")
#install.packages("DBI")
#install.packages("dplyr")
#install.packages("fitdistrplus")
#install.packages("ggplot2")
#install.packages("qicharts2")
#install.packages("psych")
#install.packages("distributions3")
library(psych)
library(qicharts2)
library(ggplot2)
library(fitdistrplus)
library(dplyr)
library(odbc)
library(distributions3)
```

Define functions

```{r}
# function to return 2-sample z statistic and p value
z.test <- function(x, y){
  # get the sample mean, sd and n
  mu_1 = mean(x)
  mu_2 = mean(y)
  sigma_1 = sd(x)^2
  sigma_2 = sd(y)^2
  n_1 = length(x)
  n_2 = length(y)
  
  # calculate 2 tailed z stat
  z_stat = (mu_1 - mu_2) / (sqrt ((sigma_1/n_1) + (sigma_2/n_2)))
  
  # calculate p value
  Z <- Normal(0,1) # make a standard normal r.v
  p = 2 * cdf(Z, abs(z_stat))
  return(c(z_stat, p))
}
```

```{r}
z.paired <- function(x, y, d0, alpha){
  if(missing(d0)){d0 <- 0}
  if(missing(alpha)){alpha <- 0.05}
  mean_diff <- mean(x-y)
  sigma_diff <- sqrt(var(x)+var(y)-2*cov(x,y))
  n <- length(x)
  z<-sqrt(n)*((mean_diff-d0)/sigma_diff)
  p_value=2*pnorm(-abs(z))
  
    # qnorm gives the alpha quantile of the standard normal  distribution
  # reject H0 that difference of means = d0 if z < z(alpha/2) or
  # z > z(1-alpha/2)
  
  
  if(z < qnorm(alpha/2)) {cat("Null hypothesis can be rejected. Evidence the difference in means is not equal to", d0)}
  if (z > qnorm(1 - (alpha/2))) {
  print("Null hypothesis can be rejected. Evidence the difference in means is not equal to", d0)}
  if ( qnorm(alpha/2)< z & z < qnorm(1- (alpha/2))) {  cat("Null hypothesis can not be rejected, evidence the difference in means is equal to", d0)}
  
  return(c(z, p_value))
}
```


Set up the database connection
```{r}
con <- DBI::dbConnect(odbc::odbc(), 
                      Driver = "SQL Server", 
                      Server = "IT049561\\SQLEXPRESS", 
                      Database = "MPC", 
                      Trusted_Connection = "True")
```


Get a dataframe for each beam energy
```{sql connection=con, output.var = "df6x"}
SELECT *
FROM "6x"
```
```{sql connection=con, output.var = "df10x"}
SELECT *
FROM "10x"

```
```{sql connection=con, output.var = "df10fff"}
SELECT *
FROM "10fff"

```

Get the dataframes of the recent data - from 1st April 2021 when we measured the water phantom
```{sql connection=con, output.var=recent6x}
SELECt *
FROM "6x"
WHERE QA_Date >= '2021-04-01'
```

```{sql connection=con, output.var=recent10x}
SELECt *
FROM "10x"
WHERE QA_Date >= '2021-04-01'
```

```{sql connection=con, output.var=recent10fff}
SELECt *
FROM "10fff"
WHERE QA_Date >= '2021-04-01'
```

Descriptive statistics with psych
```{r, echo = FALSE}
describeBy(df6x$MPC_Distance)

describeBy(df6x$Calibrated_Distance)

describeBy(df6x$Uniformity)

describeBy(df6x$Output_Change)
```


Define the random samples
```{r}
set.seed(1) # set seed makes the analysis reproducible
rand_6x <- recent6x[sample(nrow(recent6x), size=50), ]
rand_10x <- recent10x[sample(nrow(recent10x), size=50), ]
rand_10fff <- recent10fff[sample(nrow(recent10fff), size=50), ]
```

Energy: 6x
Comparing: Symmetry inline and crossline directions after calibration
Z test null hypothesis: the means of the two groups are equal
The Z test statistic is inside the 95% confidence interval, so we can not reject the null hypothesis. 
The p-value tells us how statistically significant this is and it is quite large; but still we don't have enough evidence to reject the null hypothesis.
```{r}
boxplot(rand_6x$SymmInAT, rand_6x$SymmCrossAT)
z.paired(rand_6x$SymmInAT, rand_6x$SymmCrossAT, 0, alpha = 0.05)

boxplot(rand_6x$FlatInAT, rand_6x$FlatCrossAT)
z.paired(rand_6x$FlatInAT, rand_6x$FlatCrossAT, 0, alpha = 0.05)
```
Energy 10x
Comparing symmetry inline and crossline after calibration
The null hypothesis can be rejected at a good confidence level. The means are statistically significantly different, with a good level of confidence due to the small p value. 
```{r}
boxplot(rand_10x$SymmInAT, rand_10x$SymmCrossAT)
z.paired(rand_10x$SymmInAT, rand_10x$SymmCrossAT, 0, alpha = 0.05)

boxplot(rand_10x$FlatInAT, rand_10x$FlatCrossAT)
z.paired(rand_10x$FlatInAT, rand_10x$FlatCrossAT, 0, alpha = 0.05)
```
Energy 10fff
Comparing symmetry inline and crossline
Null hypothesis can be rejected at a good level of confidence (small p value)
Means are significantly different.
```{r}
boxplot(rand_10fff$SymmInAT, rand_10fff$SymmCrossAT)
z.paired(rand_10fff$SymmInAT, rand_10fff$SymmCrossAT, 0, alpha = 0.05)

boxplot(rand_10fff$FlatInAT, rand_10fff$FlatCrossAT)
z.paired(rand_10fff$FlatInAT, rand_10fff$FlatCrossAT, 0, alpha = 0.05)
```

Paired Z tests to see if there's a significant difference as a result of applying the calibration transformation.
6x
```{r}
boxplot(rand_6x$SymmInBT, rand_6x$SymmInAT)
z.paired(rand_6x$SymmInBT, rand_6x$SymmInAT, 0, alpha = 0.05)

boxplot(rand_6x$SymmCrossBT, rand_6x$SymmCrossAT)
z.paired(rand_6x$SymmCrossBT, rand_6x$SymmCrossAT, 0, alpha = 0.05)

boxplot(rand_6x$FlatInBT, rand_6x$FlatInAT)
z.paired(rand_6x$FlatInBT, rand_6x$FlatInAT, 0, alpha = 0.05)

boxplot(rand_6x$FlatCrossBT, rand_6x$FlatCrossAT)
z.paired(rand_6x$FlatCrossBT, rand_6x$FlatCrossAT, 0, alpha = 0.05)
```
10x
```{r}
boxplot(rand_10x$SymmInBT, rand_10x$SymmInAT)
z.paired(rand_10x$SymmInBT, rand_10x$SymmInAT, 0, alpha = 0.05)

boxplot(rand_10x$SymmCrossBT, rand_10x$SymmCrossAT)
z.paired(rand_10x$SymmCrossBT, rand_10x$SymmCrossAT, 0, alpha = 0.05)

boxplot(rand_10x$FlatInBT, rand_10x$FlatInAT)
z.paired(rand_10x$FlatInBT, rand_10x$FlatInAT, 0, alpha = 0.05)

boxplot(rand_10x$FlatCrossBT, rand_10x$FlatCrossAT)
z.paired(rand_10x$FlatCrossBT, rand_10x$FlatCrossAT, 0, alpha = 0.05)
```
10fff
```{r}
boxplot(rand_10fff$SymmInBT, rand_10fff$SymmInAT)
z.paired(rand_10fff$SymmInBT, rand_10fff$SymmInAT, 0, alpha = 0.05)

boxplot(rand_10fff$SymmCrossBT, rand_10fff$SymmCrossAT)
z.paired(rand_10fff$SymmCrossBT, rand_10fff$SymmCrossAT, 0, alpha = 0.05)

boxplot(rand_10fff$FlatInBT, rand_10fff$FlatInAT)
z.paired(rand_10fff$FlatInBT, rand_10fff$FlatInAT, 0, alpha = 0.05)

boxplot(rand_10fff$FlatCrossBT, rand_10fff$FlatCrossAT)
z.paired(rand_10fff$FlatCrossBT, rand_10fff$FlatCrossAT, 0, alpha = 0.05)
```

Compare the beam centre shift
```{r}
boxplot(rand_6x$MPC_Distance, rand_6x$Calibrated_Distance)
z.paired(rand_6x$MPC_Distance, rand_6x$Calibrated_Distance, 0.5, alpha = 0.05)

boxplot(rand_10x$MPC_Distance, rand_10x$Calibrated_Distance)
z.paired(rand_10x$MPC_Distance, rand_10x$Calibrated_Distance, 0.5, alpha = 0.05)

boxplot(rand_10fff$MPC_Distance, rand_10fff$Calibrated_Distance)
z.paired(rand_10fff$MPC_Distance, rand_10fff$Calibrated_Distance, 0.5, alpha = 0.05)

```

Comparing the symmetry and flatness to Uniformity in terms of pass/fail sensitivity and specificity 

Thresholds for passing the MPC tests are
centre shift = 0.5
OutputChange = 2
Uniformity = 2

Add column which will be a pass/fail for the mpc uniformity and one for if any of the 4 symm/flat fails

6x symmetry

```{r}
# set up the df with pass/fail columns - is this necessary? yes for readibilty
recent6x$uniformity_test <- "fail"
recent6x$uniformity_test[recent6x$Uniformity<2 & recent6x$Uniformity>-2] <- "pass"

# fail if 1 of them fails
recent6x$symm_test <- "fail"
recent6x$symm_test[recent6x$SymmInAT<2 & recent6x$SymmInAT>-2 & recent6x$SymmCrossAT<2 & recent6x$SymmCrossAT>-2] <- "pass"

false_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$symm_test == "fail")
true_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$symm_test == "pass")
false_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$symm_test == "pass")
true_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$symm_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print("sens of both together")
print(sens)

spec <- true_neg / (true_neg + false_pos)
print("spec of both together")
print(spec)

# fail for inline only
recent6x$symm_in_test <- "fail"
recent6x$symm_in_test[recent6x$SymmInAT<2 & recent6x$SymmInAT>-2] <- "pass"

false_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$symm_in_test == "fail")
true_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$symm_in_test == "pass")
false_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$symm_in_test == "pass")
true_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$symm_in_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print("sensitivty of symm inline")
print(sens)

spec <- true_neg / (true_neg + false_pos)
print("specifity of symm inline")
print(spec)

# fail for crossline only
recent6x$symm_cross_test <- "fail"
recent6x$symm_cross_test[recent6x$SymmCrossAT<2 & recent6x$SymmCrossAT>-2] <- "pass"

false_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$symm_cross_test == "fail")
true_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$symm_cross_test == "pass")
false_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$symm_cross_test == "pass")
true_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$symm_cross_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print("sensitivty of symm crossline")
print(sens)

spec <- true_neg / (true_neg + false_pos)
print("specifity of symm crossline")
print(spec)

```

6x flatness spec and sens compared to uniformity
```{r}

recent6x$flat_test <- "fail"
recent6x$flat_test[recent6x$FlatInAT<104 & recent6x$FlatCrossAT<104] <- "pass"

false_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$flat_test == "fail")
true_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$flat_test == "pass")
false_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$flat_test == "pass")
true_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$flat_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print(sens)

spec <- true_neg / (true_neg + false_pos)
print(spec)

# fail for inline only
recent6x$flat_in_test <- "fail"
recent6x$flat_in_test[recent6x$FlatInAT<104] <- "pass"

false_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$flat_in_test == "fail")
true_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$flat_in_test == "pass")
false_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$flat_in_test == "pass")
true_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$flat_in_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print("sensitivty of flat inline")
print(sens)

spec <- true_neg / (true_neg + false_pos)
print("specifity of flat inline")
print(spec)

# fail for crossline only
recent6x$flat_cross_test <- "fail"
recent6x$flat_cross_test[recent6x$FlatCrossAT<104] <- "pass"

false_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$flat_cross_test == "fail")
true_pos <- sum(recent6x$uniformity_test == "pass" & recent6x$flat_cross_test == "pass")
false_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$flat_cross_test == "pass")
true_neg <- sum(recent6x$uniformity_test == "fail" & recent6x$flat_cross_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print("sensitivty of flat crossline")
print(sens)

spec <- true_neg / (true_neg + false_pos)
print("specifity of flat crossline")
print(spec)

```

Percentage difference of symmetry to uniformity
```{r}
ratio <- recent6x$SymmInAT / recent6x$Uniformity
mean(ratio)

ratio <- recent6x$SymmCrossAT / recent6x$Uniformity
mean(ratio)

recent6x$AvSymm <- (recent6x$SymmInAT + recent6x$SymmCrossAT) / 2
mean( recent6x$AvSymm / recent6x$Uniformity)
```

Compare the symmetry in each direction to the uniformity
```{r}
boxplot(rand_6x$SymmInAT, rand_6x$SymmCrossAT, rand_6x$Uniformity)
boxplot(rand_10x$SymmInAT, rand_10x$SymmCrossAT, rand_10x$Uniformity)
boxplot(rand_10fff$SymmInAT, rand_10fff$SymmCrossAT, rand_10fff$Uniformity)
```


Is there a correlation between the symmetry and the uniformity?
```{r}

fit3 <- lm(SymmInAT ~ poly(SymmCrossAT , 4, raw=TRUE), recent6x) # random sample of whole dataset? 
summary(fit3)

cor.test(rand_6x$SymmCrossAT, rand_6x$SymmInAT)

cor.test(rand_6x$Uniformity, rand_6x$SymmInAT)
cor.test(rand_6x$Uniformity, rand_6x$SymmCrossAT)

cor.test(rand_6x$FlatInAT, rand_6x$FlatCrossAT)
cor.test(rand_6x$Uniformity, rand_6x$FlatCrossAT)
cor.test(rand_6x$Uniformity, rand_6x$FlatInAT)

ggplot(rand_6x, aes(x = FlatInAT, y = FlatCrossAT)) +
  geom_point(color = "blue") 

ggplot(rand_6x, aes(QA_Date)) +
   geom_point(aes(y = Uniformity), color = "red") + 
  geom_point(aes(y = FlatInAT-100), color = "blue") +
  geom_point(aes(y = FlatCrossAT-100), color = "yellow")

predicted_df <- data.frame(SymmInAT = predict(fit3, recent6x), SymmCrossAT = recent6x$SymmCrossAT)

ggplot(recent6x, aes(x = SymmInAT, y = SymmCrossAT)) +
  geom_point(color = "red") +
  geom_line(color = "blue", data = predicted_df, aes(x = SymmInAT, y = SymmCrossAT)) 


ggplot(recent6x, aes(Uniformity)) +
  geom_point(aes(y = SymmInAT), color = "blue") +
  geom_point(aes(y = SymmCrossAT), color = "yellow")

ggplot(recent6x, aes(Uniformity)) +
  geom_point(aes(y = AvSymm), color = "blue")

ggplot(recent6x, aes(QA_Date)) +
  geom_point(aes(y = Uniformity), color = "red") + 
  geom_point(aes(y = SymmInAT), color = "blue") +
  geom_point(aes(y = SymmCrossAT), color = "yellow")

```
```{r}
ggplot(recent10x, aes(SymmInAT)) +
  geom_point(aes(y = SymmCrossAT), color = "yellow")

ggplot(recent10x, aes(Uniformity)) +
  geom_point(aes(y = SymmInAT), color = "blue") +
  geom_point(aes(y = SymmCrossAT), color = "yellow")

#ggplot(recent10x, aes(Uniformity)) +
 # geom_point(aes(y = AvSymm), color = "blue")

ggplot(recent10x, aes(QA_Date)) +
  geom_point(aes(y = Uniformity), color = "red") + 
  geom_point(aes(y = SymmInAT), color = "blue") +
  geom_point(aes(y = SymmCrossAT), color = "yellow")
```
```{r}
ggplot(recent10fff, aes(SymmInAT)) +
  geom_point(aes(y = SymmCrossAT), color = "yellow")

ggplot(recent10fff, aes(Uniformity)) +
  geom_point(aes(y = SymmInAT), color = "blue") +
  geom_point(aes(y = SymmCrossAT), color = "yellow")

#ggplot(recent6x, aes(Uniformity)) +
 # geom_point(aes(y = AvSymm), color = "blue")

ggplot(recent10fff, aes(QA_Date)) +
  geom_point(aes(y = Uniformity), color = "red") + 
  geom_point(aes(y = SymmInAT), color = "blue") +
  geom_point(aes(y = SymmCrossAT), color = "yellow")
```

sensitivity and specificity of beam centre shift
the MPC distance is always within 0.5mm threshold
```{r}

recent6x$centre_mpc_test <- "fail"
recent6x$centre_mpc_test[recent6x$MPC_Distance<0.5 & recent6x$MPC_Distance>-0.5] <- "pass"

recent6x$centre_cal_test <- "fail"
recent6x$centre_cal_test[recent6x$Calibrated_Distance<0.5 & recent6x$Calibrated_Distance>-0.5] <- "pass"

false_pos <- sum(recent6x$centre_mpc_test == "pass" & recent6x$centre_cal_test == "fail")
true_pos <- sum(recent6x$centre_mpc_test == "pass" & recent6x$centre_cal_test == "pass")
false_neg <- sum(recent6x$centre_mpc_test == "fail" & recent6x$centre_cal_test == "pass")
true_neg <- sum(recent6x$centre_mpc_test == "fail" & recent6x$centre_cal_test == "fail")

sens <- true_pos / (true_pos + false_neg)
print(sens)

spec <- true_neg / (true_neg + false_pos)
print(spec)
```


plot the beam output change over time
```{r}
ggplot(df6x, aes(QA_Date, Output_Change)) +
  geom_point() +
  xlab("QA Date") +
  ylab("Output Change") +
  ggtitle("Output Changes against Time")

```
polynomial regression model

```{r}
df6x$index <- 1:length(df6x$Output_Change)

fit3 <- lm(Output_Change ~ poly(index , 56, raw=TRUE), df6x)  
fit4 <- lm(Output_Change ~ poly(index , 14, raw=TRUE), df6x)  ## quartic
summary(fit3)

plot(df6x$Output_Change, main="plot", xaxt="n")
tck <- c(1, 50, 100, 150)
axis(1, tck, labels=FALSE)
mtext(df6x$QA_Date[tck], 1, 1, at=tck)
lines(fit3$fitted.values, col=3, lwd=2)
lines(fit4$fitted.values, col=2, lwd=2)
legend("topleft", c("cubic", "quartic"), lwd=2, col=3:2)
```

Polynomial regression on this year

```{r}
recent6x$index <- 1:length(recent6x$Output_Change)

fit <- lm(Output_Change ~ poly(index , 56, raw=TRUE), recent6x)  
fit4 <- lm(Output_Change ~ poly(index , 14, raw=TRUE), recent6x)
summary(fit3)

plot(recent6x$Output_Change, main="plot", xaxt="n")
tck <- c(1, 50, 100, 150)
axis(1, tck, labels=FALSE)
mtext(recent6x$QA_Date[tck], 1, 1, at=tck)
lines(fit$fitted.values, col=3, lwd=2)
lines(fit4$fitted.values, col=2, lwd=2)
legend("topleft", c("cubic", "quartic"), lwd=2, col=3:2)
```


SPC charts for the beam centre shift over time;
the flatness and symmetry over time
```{r}

qic(df10x$MPC_Distance, chart = 'i')
qic(df10x$Calibrated_Distance, chart = 'i')
qic(df10x$MPC_Distance, chart = 'mr')
qic(df10x$Calibrated_Distance, chart = 'mr')

qic(df6x$Output_Change, x = df6x$QA_Date, chart = 'xbar')

qic(df6x$SymmInAT, chart = 'mr')

```


```{r}
qic(recent6x$SymmInAT, x = recent6x$QA_Date, chart = 'mr')
```


